datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Business {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  ownerId   String   @map("owner_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  outlets   Outlet[]
  users     User[]

  @@map("businesses")
}

model Outlet {
  id         String   @id @default(uuid())
  businessId String?  @map("business_id")
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name       String   @db.VarChar(255)
  address    String?
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")

  users        User[]
  rawMaterials RawMaterial[]
  products     Product[]
  stockLogs    StockLog[]
  orders       Order[]
  kitchenCategories KitchenCategory[]

  @@map("outlets")
}

enum Role {
  OWNER
  MANAGER
  CHEF
  STAFF
}

model User {
  id         String   @id @default(uuid())
  businessId String?  @map("business_id")
  business   Business? @relation(fields: [businessId], references: [id])
  outletId   String?  @map("outlet_id")
  outlet     Outlet?   @relation(fields: [outletId], references: [id])
  name       String?  @db.VarChar(150)
  email      String?  @unique @db.VarChar(150)
  password   String   @map("password") @db.VarChar(255) // Added password field
  role       Role?
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")

  createdMaterials RawMaterial[]
  createdRecipes   Recipe[]
  performedLogs    StockLog[]
  acknowledgedAlerts InventoryAlert[]
  chefAssignments    ChefCategoryAssignment[]
  kitchenActivity    KitchenActivityLog[]
  assignedOrderItems OrderItem[] @relation("ChefAssignment")

  @@map("users")
}

model RolePermission {
  id               String   @id @default(uuid())
  role             Role
  canEditMaterial  Boolean  @default(false) @map("can_edit_material")
  canEditCost      Boolean  @default(false) @map("can_edit_cost")
  canAdjustStock   Boolean  @default(false) @map("can_adjust_stock")
  canEditRecipe    Boolean  @default(false) @map("can_edit_recipe")
  canViewCost      Boolean  @default(false) @map("can_view_cost")
  createdAt        DateTime @default(now()) @map("created_at")

  @@map("role_permissions")
}

model Unit {
  id               String   @id @default(uuid())
  name             String   @db.VarChar(50)
  baseUnit         String?  @map("base_unit") @db.VarChar(50)
  conversionFactor Decimal? @map("conversion_factor") @db.Decimal(10, 4)
  isActive         Boolean  @default(true) @map("is_active")

  rawMaterials     RawMaterial[]
  recipeIngredients RecipeIngredient[]
  stockLogs        StockLog[]

  @@map("units")
}

model RawMaterial {
  id            String   @id @default(uuid())
  outletId      String?  @map("outlet_id")
  outlet        Outlet?  @relation(fields: [outletId], references: [id])
  name          String   @db.VarChar(150)
  category      String?  @db.VarChar(100)
  unitId        String?  @map("unit_id")
  unit          Unit?    @relation(fields: [unitId], references: [id])
  costPerUnit   Decimal? @map("cost_per_unit") @db.Decimal(10, 2)
  minStockLevel Decimal? @map("min_stock_level") @db.Decimal(10, 2)
  currentStock  Decimal? @default(0) @map("current_stock") @db.Decimal(10, 2)
  supplierName  String?  @map("supplier_name") @db.VarChar(150)
  isActive      Boolean  @default(true) @map("is_active")
  createdBy     String?  @map("created_by")
  creator       User?    @relation(fields: [createdBy], references: [id])
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  recipeIngredients RecipeIngredient[]
  stockLogs         StockLog[]
  inventoryAlerts   InventoryAlert[]

  @@map("raw_materials")
}

model Product {
  id           String   @id @default(uuid())
  outletId     String?  @map("outlet_id")
  outlet       Outlet?  @relation(fields: [outletId], references: [id])
  name         String   @db.VarChar(150)
  category     String?  @db.VarChar(100)
  sellingPrice Decimal? @map("selling_price") @db.Decimal(10, 2)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  kitchenCategoryId String? @map("kitchen_category_id")
  kitchenCategory   KitchenCategory? @relation(fields: [kitchenCategoryId], references: [id])
  
  recipes      Recipe[]
  orderItems   OrderItem[]

  @@map("products")
}

model Recipe {
  id        String   @id @default(uuid())
  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  version   Int?     @default(1)
  isLocked  Boolean? @default(false) @map("is_locked")
  createdBy String?  @map("created_by")
  creator   User?    @relation(fields: [createdBy], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  ingredients RecipeIngredient[]

  @@map("recipes")
}

model RecipeIngredient {
  id            String   @id @default(uuid())
  recipeId      String?  @map("recipe_id")
  recipe        Recipe?  @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  rawMaterialId String?  @map("raw_material_id")
  rawMaterial   RawMaterial? @relation(fields: [rawMaterialId], references: [id])
  quantity      Decimal   @db.Decimal(10, 2)
  unitId        String?   @map("unit_id")
  unit          Unit?     @relation(fields: [unitId], references: [id])
  yieldLossPercent Decimal? @default(0) @map("yield_loss_percent") @db.Decimal(5, 2)
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("recipe_ingredients")
}

enum ChangeType {
  PURCHASE
  SALE
  WASTAGE
  CORRECTION
}

model StockLog {
  id            String   @id @default(uuid())
  outletId      String?  @map("outlet_id")
  outlet        Outlet?  @relation(fields: [outletId], references: [id])
  rawMaterialId String?  @map("raw_material_id")
  rawMaterial   RawMaterial? @relation(fields: [rawMaterialId], references: [id])
  changeQuantity Decimal  @map("change_quantity") @db.Decimal(10, 2)
  unitId        String?  @map("unit_id")
  unit          Unit?    @relation(fields: [unitId], references: [id])
  changeType    ChangeType? @map("change_type")
  reason        String?
  referenceId   String?  @map("reference_id") @db.Uuid
  performedBy   String?  @map("performed_by")
  performer     User?    @relation(fields: [performedBy], references: [id])
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("stock_logs")
}

enum AlertType {
  LOW_STOCK
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
}

model InventoryAlert {
  id            String   @id @default(uuid())
  rawMaterialId String?  @map("raw_material_id")
  rawMaterial   RawMaterial? @relation(fields: [rawMaterialId], references: [id])
  alertType     AlertType? @map("alert_type")
  currentValue  Decimal? @map("current_value") @db.Decimal(10, 2)
  threshold     Decimal? @db.Decimal(10, 2)
  status        AlertStatus?
  acknowledgedBy String? @map("acknowledged_by")
  acknowledger  User?    @relation(fields: [acknowledgedBy], references: [id])
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("inventory_alerts")
}

model KitchenCategory {
  id        String   @id @default(uuid())
  outletId  String?  @map("outlet_id")
  outlet    Outlet?  @relation(fields: [outletId], references: [id], onDelete: Cascade)
  name      String   @db.VarChar(100)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  products         Product[]
  chefAssignments  ChefCategoryAssignment[]
  orderItems       OrderItem[]

  @@map("kitchen_categories")
}

model ChefCategoryAssignment {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  user              User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  kitchenCategoryId String   @map("kitchen_category_id")
  kitchenCategory   KitchenCategory? @relation(fields: [kitchenCategoryId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now()) @map("created_at")

  @@unique([userId, kitchenCategoryId])
  @@map("chef_category_assignments")
}

enum OrderStatus {
  RECEIVED
  PREPARING
  READY
  SERVED
  CANCELLED
}

model Order {
  id          String      @id @default(uuid())
  outletId    String?     @map("outlet_id")
  outlet      Outlet?     @relation(fields: [outletId], references: [id])
  tableNumber Int         @map("table_number")
  status      OrderStatus @default(RECEIVED)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @default(now()) @updatedAt @map("updated_at")

  items       OrderItem[]

  @@map("orders")
}

enum ItemStatus {
  RECEIVED
  PREPARING
  READY
  SERVED
}

model OrderItem {
  id                String   @id @default(uuid())
  orderId           String   @map("order_id")
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId         String   @map("product_id")
  product           Product  @relation(fields: [productId], references: [id])
  kitchenCategoryId String?  @map("kitchen_category_id")
  kitchenCategory   KitchenCategory? @relation(fields: [kitchenCategoryId], references: [id])
  quantity          Int
  itemStatus        ItemStatus @default(RECEIVED) @map("item_status")
  assignedToUserId  String?    @map("assigned_to_user_id")
  assignedTo        User?      @relation("ChefAssignment", fields: [assignedToUserId], references: [id])
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  activityLogs      KitchenActivityLog[]

  @@map("order_items")
}

model KitchenActivityLog {
  id          String   @id @default(uuid())
  orderItemId String   @map("order_item_id")
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  action      String   @db.VarChar(50)
  performedBy String?  @map("performed_by")
  performer   User?    @relation(fields: [performedBy], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("kitchen_activity_logs")
}
